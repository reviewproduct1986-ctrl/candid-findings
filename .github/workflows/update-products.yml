name: Update Product Data

on:
  # Run every two hours
  schedule:
    - cron: '48 */2 * * *'
  
  # Manual trigger
  workflow_dispatch:

  # Auto-deploy when code changes
  push:
    branches:
      - production
    paths:
      - 'src/**'
      - 'public/**'
      - 'scripts/**'
      - 'package.json'
      - 'webpack.config.js'
      - 'webpack.*.js'
      - '.github/workflows/update-products.yml'

env:
  AWS_REGION: us-east-1
  S3_BUCKET: candid-findings

permissions:
  contents: write

jobs:
  update-products:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ“¦ Install PA-API SDK
        run: npm install paapi5-nodejs-sdk
      
      - name: ğŸ”„ Update products with PA-API
        env:
          AMAZON_PARTNER_TAG: ${{ secrets.AMAZON_PARTNER_TAG }}
          PAAPI_ACCESS_KEY: ${{ secrets.PAAPI_ACCESS_KEY }}
          PAAPI_SECRET_KEY: ${{ secrets.PAAPI_SECRET_KEY }}
        run: |
          echo "ğŸ“Š Fetching latest product data from Amazon..."
          node scripts/paapi-api.js > public/data/paapi-cron.txt
          echo "âœ… Product data updated"
      
      - name: ğŸ” Check for changes
        id: verify_diff
        run: |
          if git diff --quiet public/data/products*.json public/data/paapi-cron.txt; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
          fi
      
      - name: ğŸ’¾ Commit changes
        if: steps.verify_diff.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add public/data/products*.json public/data/paapi-cron.txt
          git commit -m "ğŸ¤– Update product data - $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push
      
      - name: ğŸ”‘ Configure AWS credentials
        if: steps.verify_diff.outputs.changed == 'true'
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ“¤ Sync data files to S3
        if: steps.verify_diff.outputs.changed == 'true'
        run: |
          echo "ğŸ“¤ Uploading updated data files to S3..."
          
          # Only sync data directory with short cache
          aws s3 sync public/data/ s3://${{ env.S3_BUCKET }}/data/ \
            --cache-control "public, max-age=300" \
            --exclude "*" \
            --include "products*.json" \
            --include "paapi-cron.txt"
          
          echo "âœ… Data files synced to S3"
      
      - name: âš¡ Invalidate CloudFront cache
        if: steps.verify_diff.outputs.changed == 'true'
        env:
          DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          if [ -n "$DISTRIBUTION_ID" ]; then
            echo "ğŸ”„ Invalidating CloudFront cache for data files..."
            aws cloudfront create-invalidation \
              --distribution-id $DISTRIBUTION_ID \
              --paths "/data/products*.json" "/data/paapi-cron.txt"
            echo "âœ… CloudFront cache invalidated"
          else
            echo "âš ï¸ CloudFront not configured"
          fi
      
      - name: ğŸ“Š Update Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š PRODUCT UPDATE SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Status: ${{ job.status }}"
          echo "Changes: ${{ steps.verify_diff.outputs.changed }}"
          echo "Time: $(date +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          if [ "${{ steps.verify_diff.outputs.changed }}" == "true" ]; then
            echo "âœ… Product data updated and deployed"
          else
            echo "â„¹ï¸ No changes - data already up to date"
          fi
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"